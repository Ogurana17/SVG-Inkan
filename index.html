<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>SVG Inkan</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: "Yuji Syuku, Noto Serif JP, Hiragino Mincho ProN", "Yu Mincho", serif;
      text-align: center;
      background: #f8f9fa;
    }

    .container {
      max-width: 420px;
      margin: 0 auto;
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .card {
      margin-bottom: 1.5rem;
    }

    .svg-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 2rem;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }

    svg {
      border: 1px solid #ccc;
      background: #fff;
      width: 100%;
      height: auto;
      max-width: 320px;
      max-height: 320px;
      box-sizing: border-box;
      display: block;
    }

    .inkan-label {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    @media (max-width: 600px) {
      .container {
        max-width: 100vw;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      .svg-container {
        margin-top: 1rem;
        padding-left: 0;
        padding-right: 0;
      }
      svg {
        max-width: 100vw;
        max-height: 60vw;
        min-width: 0;
      }
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <h2 class="mb-4">SVG Inkan</h2>
    <div class="card shadow-sm mx-auto">
      <div class="card-body">
        <form onsubmit="event.preventDefault(); updateStamp();">
          <div class="mb-3 text-start">
            <label class="inkan-label form-label">部署名</label>
            <input type="text" id="deptInput" class="form-control" value="××課" />
          </div>
          <div class="mb-3 text-start">
            <label class="inkan-label form-label">氏名</label>
            <input type="text" id="nameInput" class="form-control" value="〇〇" />
          </div>
          <div class="mb-3 text-start">
            <label class="inkan-label form-label">作成日</label>
            <div id="currentDate" class="form-control-plaintext ps-2"></div>
          </div>
          <div class="alert alert-info py-2 mb-3" style="font-size: 0.98rem;">
            Excelで印鑑画像を利用される場合、<b>Inkscape等のSVG→PDF変換環境があれば「SVGダウンロード」をご利用ください</b>。<br>
            <b>変換環境がない場合は「PDFダウンロード」をご利用ください</b>（PDFは画像形式となります）。
          </div>
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-danger" onclick="onUpdateButton()">更新</button>
            <button type="button" class="btn btn-outline-secondary" onclick="downloadSVG()">SVGダウンロード</button>
            <button type="button" class="btn btn-outline-secondary" onclick="downloadPDF()">PDFダウンロード</button>
          </div>
        </form>
      </div>
    </div>
    <div class="svg-container">
      <svg id="Inkan" width="300" height="300" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
        <circle cx="30" cy="30" r="28" fill="none" stroke="#EF454A" stroke-width="1.2" />
        <line x1="3" y1="22" x2="57" y2="22" stroke="#EF454A" stroke-width="0.6" />
        <line x1="3" y1="38" x2="57" y2="38" stroke="#EF454A" stroke-width="0.6" />
        <text id="deptText" x="30" y="18" font-size="5.6" fill="#EF454A" text-anchor="middle"
          font-family="Yuji Syuku, Noto Serif JP, Hiragino Mincho ProN, Yu Mincho, serif" font-weight="700"></text>
        <text id="dateText" x="30" y="32" font-size="7.2" fill="#EF454A" text-anchor="middle"
          font-family="Yuji Syuku, Noto Serif JP, Hiragino Mincho ProN, Yu Mincho, serif" font-weight="700"></text>
        <text id="nameText" x="30" y="48" font-size="9.6" fill="#EF454A" text-anchor="middle"
          font-family="Yuji Syuku, Noto Serif JP, Hiragino Mincho ProN, Yu Mincho, serif" font-weight="700"></text>
      </svg>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
  <script>
    function padZero(num) { return num.toString().padStart(2, "0"); }
    function getCurrentDateFormatted() {
      const today = new Date();
      return `${today.getFullYear()}.${padZero(today.getMonth() + 1)}.${padZero(today.getDate())}`;
    }

    // ランダム色と太さ
    function randomizeColor(baseHex) {
      const base = [
        parseInt(baseHex.substr(1, 2), 16),
        parseInt(baseHex.substr(3, 2), 16),
        parseInt(baseHex.substr(5, 2), 16)
      ];
      const rand = base.map(v =>
        Math.max(0, Math.min(255, v + Math.floor(Math.random() * 37) - 20))
      );
      return `rgb(${rand[0]},${rand[1]},${rand[2]})`;
    }
    function randomizeStroke(base) {
      const ratio = 1 + (Math.random() * 0.4 - 0.2);
      if (base < 0.1) return (base * (1 + (1 - ratio) * 5)).toFixed(3);
      else return (base * ratio).toFixed(3);
    }

    // パス化→はみ出し判定→1pt大きくして再パス化を繰り返し、はみ出したら1pt戻す
    function textToPathFitGrow(font, text, x, y, initialFontSize, id, color = "#EF454A", strokeWidth = randomizeStroke(0.07)) {
      const oldPath = document.getElementById(id + "Path");
      if (oldPath) oldPath.remove();
      if (!text) return;

      let fontSize = initialFontSize;
      let path, bbox;
      const cx = 30, cy = 30, r = 28 - 0.8;
      let isOverflow = false;
      let maxFontSize = 60;

      let yMin = 3, yMax = 22;
      if (id === "date") { yMin = 22; yMax = 38; }
      if (id === "name") { yMin = 38; yMax = 57; }

      while (fontSize < maxFontSize) {
        const glyphs = font.stringToGlyphs(text);
        let textWidth = 0;
        glyphs.forEach(function (glyph, i) {
          const prevGlyph = glyphs[i - 1];
          if (i > 0) textWidth += font.getKerningValue(prevGlyph, glyph);
          textWidth += glyph.advanceWidth * (fontSize / font.unitsPerEm);
        });
        const xLeft = x - textWidth / 2;
        path = font.getPath(text, xLeft, y, fontSize);
        bbox = path.getBoundingBox();

        const points = [
          [bbox.x1, bbox.y1],
          [bbox.x2, bbox.y1],
          [bbox.x1, bbox.y2],
          [bbox.x2, bbox.y2],
        ];
        isOverflow = !points.every(([px, py]) => (px - cx) ** 2 + (py - cy) ** 2 <= r ** 2);
        if (bbox.y1 < yMin || bbox.y2 > yMax) isOverflow = true;

        if (isOverflow) {
          fontSize -= 1;
          break;
        }
        fontSize += 1;
      }

      const glyphs = font.stringToGlyphs(text);
      let textWidth = 0;
      glyphs.forEach(function (glyph, i) {
        const prevGlyph = glyphs[i - 1];
        if (i > 0) textWidth += font.getKerningValue(prevGlyph, glyph);
        textWidth += glyph.advanceWidth * (fontSize / font.unitsPerEm);
      });
      const xLeft = x - textWidth / 2;
      path = font.getPath(text, xLeft, y, fontSize);

      bbox = path.getBoundingBox();
      const yCenter = yMin + (yMax - yMin) / 2;
      const yOffset = yCenter - (bbox.y1 + bbox.y2) / 2;
      path = font.getPath(text, xLeft, y + yOffset, fontSize);

      const svgPathData = path.toPathData(3);
      const svg = document.getElementById("Inkan");
      const newPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
      newPath.setAttribute("id", id + "Path");
      newPath.setAttribute("d", svgPathData);
      newPath.setAttribute("fill", color);
      newPath.setAttribute("stroke", color);
      newPath.setAttribute("stroke-width", strokeWidth);
      svg.appendChild(newPath);

      const textElem = document.getElementById(id + "Text");
      if (textElem) textElem.remove();
    }

    // スタンプ更新
    function updateStamp() {
      const date = getCurrentDateFormatted();
      const dept = document.getElementById("deptInput").value;
      const name = document.getElementById("nameInput").value;

      const color = randomizeColor("#EF454A");
      const strokeOuter = randomizeStroke(1.2);
      const strokeLine = randomizeStroke(0.6);

      const svg = document.getElementById("Inkan");
      svg.querySelector("circle").setAttribute("stroke", color);
      svg.querySelector("circle").setAttribute("stroke-width", strokeOuter);
      const lines = svg.querySelectorAll("line");
      lines[0].setAttribute("stroke", color);
      lines[0].setAttribute("stroke-width", strokeLine);
      lines[1].setAttribute("stroke", color);
      lines[1].setAttribute("stroke-width", strokeLine);

      ["date", "dept", "name"].forEach(function (id) {
        if (!document.getElementById(id + "Text")) {
          let textElem = document.createElementNS("http://www.w3.org/2000/svg", "text");
          if (id === "dept") { textElem.setAttribute("x", "30"); textElem.setAttribute("y", "18"); textElem.setAttribute("font-size", "5.6"); }
          else if (id === "date") { textElem.setAttribute("x", "30"); textElem.setAttribute("y", "32"); textElem.setAttribute("font-size", "7.2"); }
          else if (id === "name") { textElem.setAttribute("x", "30"); textElem.setAttribute("y", "48"); textElem.setAttribute("font-size", "9.6"); }
          textElem.setAttribute("fill", color);
          textElem.setAttribute("text-anchor", "middle");
          textElem.setAttribute("font-family", "Yuji Syuku, Noto Serif JP, Hiragino Mincho ProN, Yu Mincho, serif");
          textElem.setAttribute("font-weight", "700");
          textElem.setAttribute("id", id + "Text");
          svg.appendChild(textElem);
        }
      });

      document.getElementById("dateText").textContent = date;
      document.getElementById("deptText").textContent = dept;
      document.getElementById("nameText").textContent = name;
      document.getElementById("dateText").style.display = "";
      document.getElementById("deptText").style.display = "";
      document.getElementById("nameText").style.display = "";

      ["date", "dept", "name"].forEach(function (id) {
        const oldPath = document.getElementById(id + "Path");
        if (oldPath) oldPath.remove();
      });

      opentype.load('fonts/YujiSyuku-Regular.ttf', function (err, font) {
        if (err) {
          alert('フォントの読み込みに失敗しました');
          return;
        }
        const strokeDept = randomizeStroke(0.07);
        const strokeDate = randomizeStroke(0.07);
        const strokeName = randomizeStroke(0.07);

        textToPathFitGrow(font, dept, 30, 18, 5.6, "dept", color, strokeDept);
        textToPathFitGrow(font, date, 30, 32, 7.2, "date", color, strokeDate);
        textToPathFitGrow(font, name, 30, 48, 9.6, "name", color, strokeName);
      });
    }

    function getQueryParams() {
      const params = {};
      location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (str, key, value) {
        params[decodeURIComponent(key)] = decodeURIComponent(value.replace(/\+/g, " "));
        return "";
      });
      return params;
    }

    document.addEventListener("DOMContentLoaded", function () {
      const params = getQueryParams();
      if (params.dept) document.getElementById("deptInput").value = params.dept;
      if (params.name) document.getElementById("nameInput").value = params.name;

      const currentDate = getCurrentDateFormatted();
      document.getElementById("currentDate").textContent = currentDate;
      document.getElementById("dateText").textContent = currentDate;
      document.getElementById("deptText").textContent = "";
      document.getElementById("nameText").textContent = "";
      updateStamp();
    });

    function onUpdateButton() {
      const dept = encodeURIComponent(document.getElementById("deptInput").value);
      const name = encodeURIComponent(document.getElementById("nameInput").value);
      const url = `${location.pathname}?dept=${dept}&name=${name}`;
      location.href = url;
    }

    // downloadSVG, downloadPDF 関数を修正
    function downloadSVG() {
      const svg = document.getElementById("Inkan");
      const serializer = new XMLSerializer();
      let source = serializer.serializeToString(svg);
      source = source.replace(/>\s+</g, '><').replace(/\s{2,}/g, ' ').replace(/[\r\n]+/g, '').replace(/ ?([=]) ?/g, '$1');
      const blob = new Blob([source], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      // 日付をyyyymmdd形式で取得
      const today = new Date();
      const yyyymmdd = today.getFullYear().toString() +
        String(today.getMonth() + 1).padStart(2, "0") +
        String(today.getDate()).padStart(2, "0");

      const a = document.createElement("a");
      a.href = url;
      a.download = `Inkan_${yyyymmdd}.svg`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadPDF() {
      const svgElem = document.getElementById("Inkan");
      const width = svgElem.viewBox.baseVal.width || 60;
      const height = svgElem.viewBox.baseVal.height || 60;
      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(svgElem);
      const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(svgBlob);

      // 日付をyyyymmdd形式で取得
      const today = new Date();
      const yyyymmdd = today.getFullYear().toString() +
        String(today.getMonth() + 1).padStart(2, "0") +
        String(today.getDate()).padStart(2, "0");

      const img = new window.Image();
      img.onload = function () {
        const canvas = document.createElement("canvas");
        canvas.width = width * 5;
        canvas.height = height * 5;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const pngData = canvas.toDataURL("image/png");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: "portrait",
          unit: "mm",
          format: [width, height]
        });
        pdf.addImage(pngData, 'PNG', 0, 0, width, height);
        pdf.save(`Inkan_${yyyymmdd}.pdf`);
        URL.revokeObjectURL(url);
      };
      img.onerror = function () {
        alert("SVG画像の変換に失敗しました。");
        URL.revokeObjectURL(url);
      };
      img.src = url;
    }
  </script>
</body>
</html>