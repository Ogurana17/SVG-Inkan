<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>SVG Inkan</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: "Noto Serif JP, Hiragino Mincho ProN", "Yu Mincho", serif;
      text-align: center;
      background: #f8f9fa;
    }

    .container {
      max-width: 420px;
      margin: 0 auto;
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .card {
      margin-bottom: 1.5rem;
    }

    .svg-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 2rem;
      /* 余白を少し残す */
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }

    svg {
      border: 1px solid #ccc;
      background: #fff;
      width: 100%;
      height: auto;
      max-width: 320px;
      max-height: 320px;
      box-sizing: border-box;
      /* スマホで横スクロールしないように */
      display: block;
    }

    .inkan-label {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    @media (max-width: 600px) {
      .container {
        max-width: 100vw;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      .svg-container {
        margin-top: 1rem;
        padding-left: 0;
        padding-right: 0;
      }
      svg {
        max-width: 100vw;
        max-height: 60vw;
        min-width: 0;
      }
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <h2 class="mb-4">SVG Inkan</h2>
    <div class="card shadow-sm mx-auto">
      <div class="card-body">
        <form onsubmit="event.preventDefault(); updateStamp();">
          <div class="mb-3 text-start">
            <label class="inkan-label form-label">部署名</label>
            <input type="text" id="deptInput" class="form-control" value="××課" />
          </div>
          <div class="mb-3 text-start">
            <label class="inkan-label form-label">氏名</label>
            <input type="text" id="nameInput" class="form-control" value="〇〇" />
          </div>
          <div class="mb-3 text-start">
            <label class="inkan-label form-label">作成日</label>
            <div id="currentDate" class="form-control-plaintext ps-2"></div>
          </div>
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-danger" onclick="updateStamp()">更新</button>
            <button type="button" class="btn btn-outline-secondary" onclick="downloadSVG()">SVGダウンロード</button>
          </div>
        </form>
      </div>
    </div>
    <div class="svg-container">
      <svg id="Inkan" width="300" height="300" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
        <!-- 外円 -->
        <circle cx="30" cy="30" r="28" fill="none" stroke="#EF454A" stroke-width="1.2" />
        <!-- 上下の仕切り線 -->
        <line x1="3" y1="22" x2="57" y2="22" stroke="#EF454A" stroke-width="0.6" />
        <line x1="3" y1="38" x2="57" y2="38" stroke="#EF454A" stroke-width="0.6" />

        <!-- 部署名（上段） -->
        <text id="deptText" x="30" y="18" font-size="5.6" fill="#EF454A" text-anchor="middle"
          font-family="Noto Serif JP, Hiragino Mincho ProN, Yu Mincho, serif" font-weight="700" font-kerning="normal"></text>

        <!-- 日付（中段） -->
        <text id="dateText" x="30" y="32" font-size="7.2" fill="#EF454A" text-anchor="middle"
          font-family="Noto Serif JP, Hiragino Mincho ProN, Yu Mincho, serif" font-weight="700" font-kerning="normal"></text>

        <!-- 氏名（下段） -->
        <text id="nameText" x="30" y="48" font-size="9.6" fill="#EF454A" text-anchor="middle"
          font-family="Noto Serif JP, Hiragino Mincho ProN, Yu Mincho, serif" font-weight="700" font-kerning="normal"></text>
      </svg>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>
  <script>
    function padZero(num) {
      return num.toString().padStart(2, "0");
    }
    function getCurrentDateFormatted() {
      const today = new Date();
      const year = today.getFullYear();
      const month = padZero(today.getMonth() + 1);
      const day = padZero(today.getDate());
      return `${year}.${month}.${day}`;
    }

    // アウトライン化用の関数（中央揃え）
    function textToPath(font, text, x, y, fontSize, id, color = "#EF454A", strokeWidth = "0.07") {
      const oldPath = document.getElementById(id + "Path");
      if (oldPath) oldPath.remove();
      if (!text) return;

      const glyphs = font.stringToGlyphs(text);
      let textWidth = 0;
      glyphs.forEach(function (glyph, i) {
        const prevGlyph = glyphs[i - 1];
        if (i > 0) {
          textWidth += font.getKerningValue(prevGlyph, glyph);
        }
        textWidth += glyph.advanceWidth * (fontSize / font.unitsPerEm);
      });
      const xLeft = x - textWidth / 2;

      const path = font.getPath(text, xLeft, y, fontSize);
      const svgPathData = path.toPathData(3);

      const svg = document.getElementById("Inkan");
      const newPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
      newPath.setAttribute("id", id + "Path");
      newPath.setAttribute("d", svgPathData);
      newPath.setAttribute("fill", color);
      newPath.setAttribute("stroke", color);
      newPath.setAttribute("stroke-width", strokeWidth);
      svg.appendChild(newPath);

      // 変換後、元の<text>要素を削除
      const textElem = document.getElementById(id + "Text");
      if (textElem) textElem.remove();
    }

    // #EF454Aの各RGB値を-16～+16の範囲でランダム変化
    // （例）Math.floor(Math.random() * (上限-下限+1)) + 下限
    function randomizeColor(baseHex) {
      const base = [
        parseInt(baseHex.substr(1, 2), 16),
        parseInt(baseHex.substr(3, 2), 16),
        parseInt(baseHex.substr(5, 2), 16)
      ];
      const rand = base.map(v =>
        Math.max(0, Math.min(255, v + Math.floor(Math.random() * 33) - 16))
      );
      return `rgb(${rand[0]},${rand[1]},${rand[2]})`;
    }

    // strokeの太さを-16%～+16%でランダム変化
    // （例）Math.random() * (上限-下限) + 下限
    function randomizeStroke(base) {
      const ratio = 1 + (Math.random() * 0.32 - 0.16);
      return (base * ratio).toFixed(3);
    }

    /**
     * opentype.js で各グリフの advanceWidth を取得し、視覚規則に基づき <tspan dx="..."> を自動生成
     * @param {opentype.Font} font - opentype.jsで読み込んだフォント
     * @param {string} text - 対象テキスト
     * @param {number} fontSize - SVG上のフォントサイズ
     * @param {Object} visualRules - 例: { "トウ": -0.2, "ッカ": -0.15 }
     * @returns {string} - <tspan>列
     */
    function generateTspans(font, text, fontSize, visualRules = {}) {
      const unitsPerEm = font.unitsPerEm;
      let tspans = [];
      let prevGlyph = null;
      let prevChar = '';
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const glyph = font.charToGlyph(char);
        let dx = 0;

        // advanceWidthを基本値とする
        if (prevGlyph) {
          dx = prevGlyph.advanceWidth * (fontSize / unitsPerEm);
          // カーニング
          dx += font.getKerningValue(prevGlyph, glyph) * (fontSize / unitsPerEm);
        }

        // 視覚規則による補正
        const pair = prevChar + char;
        if (visualRules[pair]) {
          dx += visualRules[pair] * fontSize; // 補正値はem単位で
        }

        // 1文字目はdx不要
        const dxAttr = i === 0 ? '' : ` dx="${dx.toFixed(2)}"`;
        tspans.push(`<tspan${dxAttr}>${char}</tspan>`);

        prevGlyph = glyph;
        prevChar = char;
      }
      return tspans.join('');
    }

    // 例：SVGテキスト要素にtspanを適用
    function setTextWithTspans(font, elemId, text, fontSize, visualRules = {}) {
      const elem = document.getElementById(elemId);
      if (!elem) return;
      elem.setAttribute('font-size', fontSize);
      elem.innerHTML = generateTspans(font, text, fontSize, visualRules);
    }

    // スタンプ更新関数
    function updateStamp() {
      const date = getCurrentDateFormatted();
      const dept = document.getElementById("deptInput").value;
      const name = document.getElementById("nameInput").value;

      // ランダム色と太さ
      const color = randomizeColor("#EF454A");
      const strokeOuter = randomizeStroke(1.2);
      const strokeLine = randomizeStroke(0.6);
      const strokeText = randomizeStroke(0.07);

      // SVG要素取得
      const svg = document.getElementById("Inkan");

      // 外円・仕切り線の属性を更新
      svg.querySelector("circle").setAttribute("stroke", color);
      svg.querySelector("circle").setAttribute("stroke-width", strokeOuter);
      const lines = svg.querySelectorAll("line");
      lines[0].setAttribute("stroke", color);
      lines[0].setAttribute("stroke-width", strokeLine);
      lines[1].setAttribute("stroke", color);
      lines[1].setAttribute("stroke-width", strokeLine);

      // 既存の<text>がなければ再生成
      ["date", "dept", "name"].forEach(function (id) {
        if (!document.getElementById(id + "Text")) {
          let textElem = document.createElementNS("http://www.w3.org/2000/svg", "text");
          if (id === "dept") {
            textElem.setAttribute("x", "30");
            textElem.setAttribute("y", "18");
            textElem.setAttribute("font-size", "5.6");
          } else if (id === "date") {
            textElem.setAttribute("x", "30");
            textElem.setAttribute("y", "32");
            textElem.setAttribute("font-size", "7.2");
          } else if (id === "name") {
            textElem.setAttribute("x", "30");
            textElem.setAttribute("y", "48");
            textElem.setAttribute("font-size", "9.6");
          }
          textElem.setAttribute("fill", color);
          textElem.setAttribute("text-anchor", "middle");
          textElem.setAttribute("font-family", "Noto Serif JP, Hiragino Mincho ProN, Yu Mincho, serif");
          textElem.setAttribute("font-weight", "700");
          textElem.setAttribute("font-kerning", "normal");
          textElem.setAttribute("id", id + "Text");
          svg.appendChild(textElem);
        }
      });

      // テキスト内容をセット
      document.getElementById("dateText").textContent = date;
      document.getElementById("deptText").textContent = dept;
      document.getElementById("nameText").textContent = name;
      document.getElementById("dateText").style.display = "";
      document.getElementById("deptText").style.display = "";
      document.getElementById("nameText").style.display = "";

      // 既存のパスを削除
      ["date", "dept", "name"].forEach(function (id) {
        const oldPath = document.getElementById(id + "Path");
        if (oldPath) oldPath.remove();
      });

      // パス変換
      opentype.load('fonts/NotoSerifJP-Bold.ttf', function (err, font) {
        if (err) {
          alert('フォントの読み込みに失敗しました');
          return;
        }
        // 各テキストごとにstrokeTextをランダム化
        const strokeDept = randomizeStroke(0.07);
        const strokeDate = randomizeStroke(0.07);
        const strokeName = randomizeStroke(0.07);

        textToPath(font, dept, 30, 18, 5.6, "dept", color, strokeDept);
        textToPath(font, date, 30, 32, 7.2, "date", color, strokeDate);
        textToPath(font, name, 30, 48, 9.6, "name", color, strokeName);
      });
    }

    // ページロード時に日付をセットし、パス変換も実行
    document.addEventListener("DOMContentLoaded", function () {
      const currentDate = getCurrentDateFormatted();
      document.getElementById("currentDate").textContent = currentDate;
      document.getElementById("dateText").textContent = currentDate;
      document.getElementById("deptText").textContent = "";
      document.getElementById("nameText").textContent = "";
      updateStamp();
    });

    function downloadSVG() {
      const svg = document.getElementById("Inkan");
      const serializer = new XMLSerializer();
      let source = serializer.serializeToString(svg);

      // SVGのminify: 不要な空白・改行・インデントを削除
      source = source
        .replace(/>\s+</g, '><')      // タグ間の空白・改行を削除
        .replace(/\s{2,}/g, ' ')      // 連続スペースを1つに
        .replace(/[\r\n]+/g, '')      // 改行を削除
        .replace(/ ?([=]) ?/g, '$1'); // =の前後スペースを削除

      const blob = new Blob([source], {
        type: "image/svg+xml;charset=utf-8",
      });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "Inkan.svg";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>

</html>