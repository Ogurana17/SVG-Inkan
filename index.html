<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>SVG Inkan</title>
  <style>
    body {
      font-family: "Noto Serif JP, Hiragino Mincho ProN", "Yu Mincho", serif;
      text-align: center;
    }

    svg {
      border: 1px solid #ccc;
      margin: 10px;
    }

    .form-container {
      margin: 20px;
    }

    input {
      margin: 5px;
      padding: 5px;
    }

    button {
      margin-top: 10px;
      padding: 5px 15px;
    }
  </style>
</head>

<body>
  <h2>SVG Inkan</h2>
  <div class="form-container">
    <label>日付 (yyyy.mm.dd):
      <input type="text" id="dateInput" value="" /></label><br />
    <label>部署名: <input type="text" id="deptInput" value="××課" /></label><br />
    <label>氏名: <input type="text" id="nameInput" value="〇〇" /></label><br />
    <button onclick="updateStamp()">更新</button>
    <button onclick="downloadSVG()">SVGダウンロード</button>
  </div>

  <svg id="Inkan" width="300" height="300" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
    <!-- 外円 -->
    <circle cx="30" cy="30" r="28" fill="none" stroke="#EF454A" stroke-width="1.2" />
    <!-- 上下の仕切り線 -->
    <line x1="3" y1="22" x2="57" y2="22" stroke="#EF454A" stroke-width="0.6" />
    <line x1="3" y1="38" x2="57" y2="38" stroke="#EF454A" stroke-width="0.6" />

    <!-- 部署名（上段） -->
    <text id="deptText" x="30" y="18" font-size="5.6" fill="#EF454A" text-anchor="middle"
      font-family="Noto Serif JP, Hiragino Mincho ProN, Yu Mincho, serif" font-weight="700" font-kerning="normal"></text>

    <!-- 日付（中段） -->
    <text id="dateText" x="30" y="32" font-size="7.2" fill="#EF454A" text-anchor="middle"
      font-family="Noto Serif JP, Hiragino Mincho ProN, Yu Mincho, serif" font-weight="700" font-kerning="normal"></text>

    <!-- 氏名（下段） -->
    <text id="nameText" x="30" y="48" font-size="9.6" fill="#EF454A" text-anchor="middle"
      font-family="Noto Serif JP, Hiragino Mincho ProN, Yu Mincho, serif" font-weight="700" font-kerning="normal"></text>
  </svg>

  <script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>
  <script>
    function padZero(num) {
      return num.toString().padStart(2, "0");
    }
    function getCurrentDateFormatted() {
      const today = new Date();
      const year = today.getFullYear();
      const month = padZero(today.getMonth() + 1);
      const day = padZero(today.getDate());
      return `${year}.${month}.${day}`;
    }

    // アウトライン化用の関数（中央揃え）
    function textToPath(font, text, x, y, fontSize, id) {
      const oldPath = document.getElementById(id + "Path");
      if (oldPath) oldPath.remove();
      if (!text) return;

      const glyphs = font.stringToGlyphs(text);
      let textWidth = 0;
      glyphs.forEach(function (glyph, i) {
        const prevGlyph = glyphs[i - 1];
        if (i > 0) {
          textWidth += font.getKerningValue(prevGlyph, glyph);
        }
        textWidth += glyph.advanceWidth * (fontSize / font.unitsPerEm);
      });
      const xLeft = x - textWidth / 2;

      const path = font.getPath(text, xLeft, y, fontSize);
      const svgPathData = path.toPathData(3);

      const svg = document.getElementById("Inkan");
      const newPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
      newPath.setAttribute("id", id + "Path");
      newPath.setAttribute("d", svgPathData);
      newPath.setAttribute("fill", "#EF454A");
      newPath.setAttribute("stroke", "#EF454A");
      newPath.setAttribute("stroke-width", "0.07");
      svg.appendChild(newPath);

      // 変換後、元の<text>要素を削除
      const textElem = document.getElementById(id + "Text");
      if (textElem) textElem.remove();
    }

    // スタンプ更新関数
    function updateStamp() {
      const date = document.getElementById("dateInput").value;
      const dept = document.getElementById("deptInput").value;
      const name = document.getElementById("nameInput").value;

      // 既存の<text>がなければ再生成
      ["date", "dept", "name"].forEach(function (id) {
        if (!document.getElementById(id + "Text")) {
          // SVGに新たな<text>要素を追加
          const svg = document.getElementById("Inkan");
          let textElem = document.createElementNS("http://www.w3.org/2000/svg", "text");
          if (id === "dept") {
            textElem.setAttribute("x", "30");
            textElem.setAttribute("y", "18");
            textElem.setAttribute("font-size", "5.6");
          } else if (id === "date") {
            textElem.setAttribute("x", "30");
            textElem.setAttribute("y", "32");
            textElem.setAttribute("font-size", "7.2");
          } else if (id === "name") {
            textElem.setAttribute("x", "30");
            textElem.setAttribute("y", "48");
            textElem.setAttribute("font-size", "9.6");
          }
          textElem.setAttribute("fill", "#EF454A");
          textElem.setAttribute("text-anchor", "middle");
          textElem.setAttribute("font-family", "Noto Serif JP, Hiragino Mincho ProN, Yu Mincho, serif");
          textElem.setAttribute("font-weight", "700");
          textElem.setAttribute("font-kerning", "normal");
          textElem.setAttribute("id", id + "Text");
          svg.appendChild(textElem);
        }
      });

      // テキスト内容をセット
      document.getElementById("dateText").textContent = date;
      document.getElementById("deptText").textContent = dept;
      document.getElementById("nameText").textContent = name;
      document.getElementById("dateText").style.display = "";
      document.getElementById("deptText").style.display = "";
      document.getElementById("nameText").style.display = "";

      // 既存のパスを削除
      ["date", "dept", "name"].forEach(function (id) {
        const oldPath = document.getElementById(id + "Path");
        if (oldPath) oldPath.remove();
      });

      // パス変換
      opentype.load('fonts/NotoSerifJP-Bold.ttf', function (err, font) {
        if (err) {
          alert('フォントの読み込みに失敗しました');
          return;
        }
        textToPath(font, dept, 30, 18, 5.6, "dept");
        textToPath(font, date, 30, 32, 7.2, "date");
        textToPath(font, name, 30, 48, 9.6, "name");
      });
    }

    // ページロード時に日付をセットし、パス変換も実行
    document.addEventListener("DOMContentLoaded", function () {
      const currentDate = getCurrentDateFormatted();
      document.getElementById("dateInput").value = currentDate;
      document.getElementById("dateText").textContent = currentDate;
      document.getElementById("deptText").textContent = "";
      document.getElementById("nameText").textContent = "";
      updateStamp();
    });

    function downloadSVG() {
      const svg = document.getElementById("Inkan");
      const serializer = new XMLSerializer();
      const source = serializer.serializeToString(svg);
      const blob = new Blob([source], {
        type: "image/svg+xml;charset=utf-8",
      });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "Inkan.svg";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>

</html>